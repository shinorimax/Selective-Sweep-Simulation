---
title: "load_and_store_data"
author: "Shinnosuke Yagi"
date: "2025-11-02"
output: html_document
---

## Overview

This notebook exists for the sole purpose of loading data simulated by Slim, calculating properties like F-matrix, gemone-wide average F-matrix, etc

## Import Libraries

```{r, message=FALSE}
library(ape)
library(spam)
library(devtools)
library(INLA)
library(pROC)
library(ggplot2)
library(dplyr)
library(purrr)
library(readr)
library(stringr)
library(fmatrix)
```

```{r}
# install_github("JuliaPalacios/phylodyn")
library(phylodyn)
```

```{r}
source("load_and_store_data_utils.R") 
# --- Ensure data directory exists ------------------------------------------
if (!dir.exists("data")) dir.create("data")

data_dir <- "/Users/yagishinnosuke/Documents/2025-2026 Stanford/Palacios Lab/Selective-Sweep-Simulation/SliM/trees_newick"
```

## Load Trees

neutrals[[i]] gives list of phylogenetic trees from the ith simulation (chromosome) under the given scenario
neutrals[[i]][[j]] gives the jth tree from the ith simulation under the given scenario

```{r}
# --- Define filename prefixes ----------------------------------------------
neutral_prefix   <- "^r300.*\\.tree$"
# selective_s0.02_f0.25_prefix <- "^r301.*\\.tree$"
# selective_s0.02_f0.5_prefix  <- "^r302.*\\.tree$"
# selective_s0.02_f0.75_prefix <- "^r303.*\\.tree$"
# selective_s0.01_f0.25_prefix <- "^r304.*\\.tree$"
# selective_s0.01_f0.5_prefix  <- "^r305.*\\.tree$"
# selective_s0.01_f0.75_prefix <- "^r306.*\\.tree$"
# selective_s0.003_f0.25_prefix <- "^r307.*\\.tree$"
# selective_s0.003_f0.5_prefix  <- "^r308.*\\.tree$"
# selective_s0.003_f0.75_prefix <- "^r309.*\\.tree$"
# selective_s0.001_f0.25_prefix <- "^r310.*\\.tree$"
# selective_s0.001_f0.5_prefix  <- "^r311.*\\.tree$"
# selective_s0.001_f0.75_prefix <- "^r312.*\\.tree$"

# --- Helper function to read & save ----------------------------------------
read_and_save <- function(pattern_name, prefix) {
  cat("Reading:", pattern_name, "\n")
  obj <- read_files_by_pattern(data_dir, prefix)
  
  saveRDS(obj, file = file.path("data", paste0(pattern_name, ".rds")))
  cat("  Saved ->", file.path("data", paste0(pattern_name, ".rds")), "\n\n")
  
  return(obj)
}

# --- Load and save data -----------------------------------------------------
neutrals <- read_and_save("neutrals", neutral_prefix)

# selectives_s0.02_f0.25 <- read_and_save("selectives_s0.02_f0.25", selective_s0.02_f0.25_prefix)
# selectives_s0.02_f0.5  <- read_and_save("selectives_s0.02_f0.5",  selective_s0.02_f0.5_prefix)
# selectives_s0.02_f0.75 <- read_and_save("selectives_s0.02_f0.75", selective_s0.02_f0.75_prefix)
# 
# selectives_s0.01_f0.25 <- read_and_save("selectives_s0.01_f0.25", selective_s0.01_f0.25_prefix)
# selectives_s0.01_f0.5  <- read_and_save("selectives_s0.01_f0.5",  selective_s0.01_f0.5_prefix)
# selectives_s0.01_f0.75 <- read_and_save("selectives_s0.01_f0.75", selective_s0.01_f0.75_prefix)
# 
# selectives_s0.003_f0.25 <- read_and_save("selectives_s0.003_f0.25", selective_s0.003_f0.25_prefix)
# selectives_s0.003_f0.5  <- read_and_save("selectives_s0.003_f0.5",  selective_s0.003_f0.5_prefix)
# selectives_s0.003_f0.75 <- read_and_save("selectives_s0.003_f0.75", selective_s0.003_f0.75_prefix)
# 
# selectives_s0.001_f0.25 <- read_and_save("selectives_s0.001_f0.25", selective_s0.001_f0.25_prefix)
# selectives_s0.001_f0.5  <- read_and_save("selectives_s0.001_f0.5",  selective_s0.001_f0.5_prefix)
# selectives_s0.001_f0.75 <- read_and_save("selectives_s0.001_f0.75", selective_s0.001_f0.75_prefix)

# --- Summary ---------------------------------------------------------------
cat("Neutral files   :", length(neutrals), "\n")
```

## Calculate F-matrix for each trees

Fs is a large list of all f-matrices. 

```{r}
# --- Example -----------------------------------------------------------------
Fs_neutrals <- compute_and_save_Fs_nested(neutrals, "neutrals")
# Fs_s0.02_f0.25 <- compute_and_save_Fs_nested(selectives_s0.02_f0.25, "selectives_s0.02_f0.25")
# Fs_s0.02_f0.5  <- compute_and_save_Fs_nested(selectives_s0.02_f0.5,  "selectives_s0.02_f0.5")
# Fs_s0.02_f0.75 <- compute_and_save_Fs_nested(selectives_s0.02_f0.75, "selectives_s0.02_f0.75")
# 
# Fs_s0.01_f0.25 <- compute_and_save_Fs_nested(selectives_s0.01_f0.25, "selectives_s0.01_f0.25")
# Fs_s0.01_f0.5  <- compute_and_save_Fs_nested(selectives_s0.01_f0.5,  "selectives_s0.01_f0.5")
# Fs_s0.01_f0.75 <- compute_and_save_Fs_nested(selectives_s0.01_f0.75, "selectives_s0.01_f0.75")
# 
# Fs_s0.003_f0.25 <- compute_and_save_Fs_nested(selectives_s0.003_f0.25, "selectives_s0.003_f0.25")
# Fs_s0.003_f0.5  <- compute_and_save_Fs_nested(selectives_s0.003_f0.5,  "selectives_s0.003_f0.5")
# Fs_s0.003_f0.75 <- compute_and_save_Fs_nested(selectives_s0.003_f0.75, "selectives_s0.003_f0.75")

# Fs_s0.001_f0.25 <- compute_and_save_Fs_nested(selectives_s0.001_f0.25, "selectives_s0.001_f0.25")
# Fs_s0.001_f0.5  <- compute_and_save_Fs_nested(selectives_s0.001_f0.5,  "selectives_s0.001_f0.5")
# Fs_s0.001_f0.75 <- compute_and_save_Fs_nested(selectives_s0.001_f0.75, "selectives_s0.001_f0.75")
# Now:
#   Fs_neutrals[[1]][[1]]  # first tree on the first chromosome
```

## Compute weighted average summary F-matrix for each chromosome

```{r}
# --- Load and compute weighted F matrices for all conditions -----------------

# Neutral
Fs_nested_neutrals <- readRDS("data/Fs_nested_neutrals.rds")
F_weighted_neutrals <- compute_weighted_Fs(
  Fs_nested = Fs_nested_neutrals,
  breaks_dir = data_dir,
  output_name = "F_weighted_average_neutrals.rds",
  store_dir = "data"
)

# # s = 0.02
# Fs_nested_selectives_s0.02_f0.25 <- readRDS("data/Fs_nested_selectives_s0.02_f0.25.rds")
# F_weighted_selectives_s0.02_f0.25 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.02_f0.25,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.02_f0.25.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.02_f0.5 <- readRDS("data/Fs_nested_selectives_s0.02_f0.5.rds")
# F_weighted_selectives_s0.02_f0.5 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.02_f0.5,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.02_f0.5.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.02_f0.75 <- readRDS("data/Fs_nested_selectives_s0.02_f0.75.rds")
# F_weighted_selectives_s0.02_f0.75 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.02_f0.75,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.02_f0.75.rds",
#   store_dir = "data"
# )
# 
# # s = 0.01
# Fs_nested_selectives_s0.01_f0.25 <- readRDS("data/Fs_nested_selectives_s0.01_f0.25.rds")
# F_weighted_selectives_s0.01_f0.25 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.01_f0.25,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.01_f0.25.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.01_f0.5 <- readRDS("data/Fs_nested_selectives_s0.01_f0.5.rds")
# F_weighted_selectives_s0.01_f0.5 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.01_f0.5,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.01_f0.5.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.01_f0.75 <- readRDS("data/Fs_nested_selectives_s0.01_f0.75.rds")
# F_weighted_selectives_s0.01_f0.75 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.01_f0.75,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.01_f0.75.rds",
#   store_dir = "data"
# )
# 
# # s = 0.003
# Fs_nested_selectives_s0.003_f0.25 <- readRDS("data/Fs_nested_selectives_s0.003_f0.25.rds")
# F_weighted_selectives_s0.003_f0.25 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.003_f0.25,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.003_f0.25.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.003_f0.5 <- readRDS("data/Fs_nested_selectives_s0.003_f0.5.rds")
# F_weighted_selectives_s0.003_f0.5 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.003_f0.5,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.003_f0.5.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.003_f0.75 <- readRDS("data/Fs_nested_selectives_s0.003_f0.75.rds")
# F_weighted_selectives_s0.003_f0.75 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.003_f0.75,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.003_f0.75.rds",
#   store_dir = "data"
# )

# # s = 0.001
# Fs_nested_selectives_s0.001_f0.25 <- readRDS("data/Fs_nested_selectives_s0.001_f0.25.rds")
# F_weighted_selectives_s0.001_f0.25 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.001_f0.25,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.001_f0.25.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.001_f0.5 <- readRDS("data/Fs_nested_selectives_s0.001_f0.5.rds")
# F_weighted_selectives_s0.001_f0.5 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.001_f0.5,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.001_f0.5.rds",
#   store_dir = "data"
# )
# 
# Fs_nested_selectives_s0.001_f0.75 <- readRDS("data/Fs_nested_selectives_s0.001_f0.75.rds")
# F_weighted_selectives_s0.001_f0.75 <- compute_weighted_Fs(
#   Fs_nested = Fs_nested_selectives_s0.001_f0.75,
#   breaks_dir = data_dir,
#   output_name = "F_weighted_average_selectives_s0.001_f0.75.rds",
#   store_dir = "data"
# )
```

## Estimate Empirical Kingman using first half of neutrals

```{r}
# Example usage:
# Fs_nested_neutrals <- readRDS("data/Fs_nested_neutrals.rds")
F_empirical_kingman <- compute_empirical_kingman(F_weighted_neutrals)
```

## Calculate Weighted F-matrix (FW) for each trees

```{r}
# --- Compute & Save Weighted F-matrices for All Scenarios --------------------

# Neutral
neutrals <- readRDS("data/neutrals.rds")
FWs_neutrals <- compute_and_save_FWs_nested(neutrals, "neutrals")

# s = 0.02
selectives_s0.02_f0.25 <- readRDS("data/selectives_s0.02_f0.25.rds")
FWs_selectives_s0.02_f0.25 <- compute_and_save_FWs_nested(selectives_s0.02_f0.25, "selectives_s0.02_f0.25")

selectives_s0.02_f0.5 <- readRDS("data/selectives_s0.02_f0.5.rds")
FWs_selectives_s0.02_f0.5 <- compute_and_save_FWs_nested(selectives_s0.02_f0.5, "selectives_s0.02_f0.5")

selectives_s0.02_f0.75 <- readRDS("data/selectives_s0.02_f0.75.rds")
FWs_selectives_s0.02_f0.75 <- compute_and_save_FWs_nested(selectives_s0.02_f0.75, "selectives_s0.02_f0.75", tol = 4L)

# s = 0.01
selectives_s0.01_f0.25 <- readRDS("data/selectives_s0.01_f0.25.rds")
FWs_selectives_s0.01_f0.25 <- compute_and_save_FWs_nested(selectives_s0.01_f0.25, "selectives_s0.01_f0.25")

selectives_s0.01_f0.5 <- readRDS("data/selectives_s0.01_f0.5.rds")
FWs_selectives_s0.01_f0.5 <- compute_and_save_FWs_nested(selectives_s0.01_f0.5, "selectives_s0.01_f0.5")

selectives_s0.01_f0.75 <- readRDS("data/selectives_s0.01_f0.75.rds")
FWs_selectives_s0.01_f0.75 <- compute_and_save_FWs_nested(selectives_s0.01_f0.75, "selectives_s0.01_f0.75")

# s = 0.003
selectives_s0.003_f0.25 <- readRDS("data/selectives_s0.003_f0.25.rds")
FWs_selectives_s0.003_f0.25 <- compute_and_save_FWs_nested(selectives_s0.003_f0.25, "selectives_s0.003_f0.25", tol=4)

selectives_s0.003_f0.5 <- readRDS("data/selectives_s0.003_f0.5.rds")
FWs_selectives_s0.003_f0.5 <- compute_and_save_FWs_nested(selectives_s0.003_f0.5, "selectives_s0.003_f0.5")

selectives_s0.003_f0.75 <- readRDS("data/selectives_s0.003_f0.75.rds")
FWs_selectives_s0.003_f0.75 <- compute_and_save_FWs_nested(selectives_s0.003_f0.75, "selectives_s0.003_f0.75")

# s = 0.001
selectives_s0.001_f0.25 <- readRDS("data/selectives_s0.001_f0.25.rds")
FWs_selectives_s0.001_f0.25 <- compute_and_save_FWs_nested(selectives_s0.001_f0.25, "selectives_s0.001_f0.25")

selectives_s0.001_f0.5 <- readRDS("data/selectives_s0.001_f0.5.rds")
FWs_selectives_s0.001_f0.5 <- compute_and_save_FWs_nested(selectives_s0.001_f0.5, "selectives_s0.001_f0.5")

selectives_s0.001_f0.75 <- readRDS("data/selectives_s0.001_f0.75.rds")
FWs_selectives_s0.001_f0.75 <- compute_and_save_FWs_nested(selectives_s0.001_f0.75, "selectives_s0.001_f0.75")
```

## Calculate weighted-average Weighted F-matrix (FW) for each trees

```{r}
# --- Load and compute weighted-average of Weighted F-matrices (FWs) ----------

# Neutral
FWs_nested_neutrals <- readRDS("data/FWs_nested_neutrals.rds")
FW_weighted_neutrals <- compute_weighted_Fs(
  Fs_nested = FWs_nested_neutrals,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_neutrals.rds",
  store_dir = "data"
)

# # s = 0.02
FWs_nested_selectives_s0.02_f0.25 <- readRDS("data/FWs_nested_selectives_s0.02_f0.25.rds")
F_weighted_selectives_s0.02_f0.25 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.02_f0.25,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.02_f0.25.rds",
  store_dir = "data"
)

FWs_nested_selectives_s0.02_f0.5 <- readRDS("data/FWs_nested_selectives_s0.02_f0.5.rds")
F_weighted_selectives_s0.02_f0.5 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.02_f0.5,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.02_f0.5.rds",
  store_dir = "data"
)

FWs_nested_selectives_s0.02_f0.75 <- readRDS("data/FWs_nested_selectives_s0.02_f0.75.rds")
F_weighted_selectives_s0.02_f0.75 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.02_f0.75,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.02_f0.75.rds",
  store_dir = "data"
)

# s = 0.01
FWs_nested_selectives_s0.01_f0.25 <- readRDS("data/FWs_nested_selectives_s0.01_f0.25.rds")
F_weighted_selectives_s0.01_f0.25 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.01_f0.25,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.01_f0.25.rds",
  store_dir = "data"
)
#
FWs_nested_selectives_s0.01_f0.5 <- readRDS("data/FWs_nested_selectives_s0.01_f0.5.rds")
F_weighted_selectives_s0.01_f0.5 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.01_f0.5,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.01_f0.5.rds",
  store_dir = "data"
)

FWs_nested_selectives_s0.01_f0.75 <- readRDS("data/FWs_nested_selectives_s0.01_f0.75.rds")
FW_weighted_selectives_s0.01_f0.75 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.01_f0.75,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.01_f0.75.rds",
  store_dir = "data"
)
# 
# # s = 0.003
FWs_nested_selectives_s0.003_f0.25 <- readRDS("data/FWs_nested_selectives_s0.003_f0.25.rds")
F_weighted_selectives_s0.003_f0.25 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.003_f0.25,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.003_f0.25.rds",
  store_dir = "data"
)
# 
FWs_nested_selectives_s0.003_f0.5 <- readRDS("data/FWs_nested_selectives_s0.003_f0.5.rds")
F_weighted_selectives_s0.003_f0.5 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.003_f0.5,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.003_f0.5.rds",
  store_dir = "data"
)
# 
FWs_nested_selectives_s0.003_f0.75 <- readRDS("data/FWs_nested_selectives_s0.003_f0.75.rds")
F_weighted_selectives_s0.003_f0.75 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.003_f0.75,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.003_f0.75.rds",
  store_dir = "data"
)
# 
# # s = 0.001
FWs_nested_selectives_s0.001_f0.25 <- readRDS("data/FWs_nested_selectives_s0.001_f0.25.rds")
F_weighted_selectives_s0.001_f0.25 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.001_f0.25,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.001_f0.25.rds",
  store_dir = "data"
)
# 
FWs_nested_selectives_s0.001_f0.5 <- readRDS("data/FWs_nested_selectives_s0.001_f0.5.rds")
F_weighted_selectives_s0.001_f0.5 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.001_f0.5,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.001_f0.5.rds",
  store_dir = "data"
)
# 
FWs_nested_selectives_s0.001_f0.75 <- readRDS("data/FWs_nested_selectives_s0.001_f0.75.rds")
F_weighted_selectives_s0.001_f0.75 <- compute_weighted_Fs(
  Fs_nested = FWs_nested_selectives_s0.001_f0.75,
  breaks_dir = data_dir,
  output_name = "FW_weighted_average_selectives_s0.001_f0.75.rds",
  store_dir = "data"
)
```

## Estimate Empirical Kingman FW matrix using first half of neutrals

```{r}
# Example usage:
# FWs_nested_neutrals <- readRDS("data/FWs_nested_neutrals.rds")
FW_empirical_kingman <- compute_empirical_kingman(FW_weighted_neutrals, output_path = "data/FW_empirical_kingman.rds")
```
